version: 2.1

setup: true

orbs: 
  continuation: circleci/continuation@0.2.0
  jq: circleci/jq@2.2.0

parameters:
  changesTrue:
    type: boolean
    default: true

jobs:
  getChanges:
    executor: continuation/default
    steps:
      - checkout
      - jq/install      
      - run: 
          name: Check API for Scheduled Pipeline trigger type also pull id for next step
          command: |
            echo $CIRCLE_SHA1
            LAST_SHA_REVISION=$(curl -H 'Circle-Token: $CIRCLE_TOKEN' -s 'https://circleci.com/api/v2/project/github/jkzilla/cci-demo101b/pipeline?branch=master' \
            | jq -r '.items | map(select(.id != "6b1a77cb-c030-46c7-9e65-e71683145465" and .trigger.type == "scheduled_pipeline" and .state == "created") | .vcs.revision) | .[0]')
            echo "last SHA revision: ${LAST_SHA_REVISION}"
            if [ ${LAST_SHA_REVISION} == ${CIRCLE_SHA1} ];
            then 
              circleci step halt
            else 
              echo "Continuing workflow"
            fi           
      - continuation/continue:
          configuration_path: /config/config2.yml
workflows:
  version: 2
  runDeployIfChangesTrue:
    when: << pipeline.parameters.changesTrue >>
    jobs:
      - getChanges:
          context:
            - CIRCLE_TOKEN
